<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analítico</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            background-image: url('/imagem/templet.jpg'); /* Replace 'background.jpg' with your image file name */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: white;
        }
        .summary {
            display: flex;
            justify-content: space-around;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
            padding: 20px;
        }
        .summary-item {
            text-align: center;
        }
        .summary-item h3 {
            margin: 0;
            color: #555;
        }
        .summary-item p {
            font-size: 24px;
            margin: 5px 0;
            color: #333;
        }
        .chart {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
            padding: 20px;
        }
        .chart h2 {
            margin-top: 0;
            color: #555;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .bar:hover {
            fill: #4CAF50;
        }
        .pie-slice:hover {
            opacity: 0.7;
        }
        @media (max-width: 768px) {
            .summary {
                flex-direction: column;
            }
            .chart {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard Analítico</h1>
        <div class="summary" id="summary">
            <!-- Summary stats will be populated by JS -->
        </div>
        <div class="chart">
            <h2>Vendas Mensais</h2>
            <div id="sales-chart"></div>
        </div>
        <div class="chart">
            <h2>Vendas por Categoria</h2>
            <div id="category-chart"></div>
        </div>
        <div class="chart">
            <h2>Distribuição por Categoria (Pizza)</h2>
            <div id="pie-chart"></div>
        </div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        console.log('D3.js loaded:', typeof d3);

        // Fetch data from Flask API
        async function fetchData() {
            try {
                console.log('Fetching data from API...');
                const response = await fetch('/api/data');
                console.log('Response received:', response);
                const data = await response.json();
                console.log('Data parsed:', data);
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                // Fallback sample data for when opened directly
                console.log('Using fallback sample data');
                return {
                    sales: [229, 433, 372, 446, 296, 313, 267, 482, 359, 441, 367, 271],
                    months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    categories: ['A', 'B', 'C', 'D'],
                    category_sales: [201, 687, 692, 597],
                    total_sales: 4276,
                    avg_sales: 356.33,
                    total_category_sales: 2177
                };
            }
        }

        // Create sales chart
        function createSalesChart(data) {
            console.log('Creating sales chart with data:', data);
            const margin = {top: 20, right: 30, bottom: 40, left: 40};
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#sales-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.months)
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(data.sales)]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            svg.append("g")
                .call(d3.axisLeft(y));

            svg.selectAll(".bar")
                .data(data.sales)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", (d, i) => x(data.months[i]))
                .attr("y", d => y(d))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d))
                .attr("fill", "#69b3a2")
                .on("mouseover", function(event, d) {
                    d3.select("#tooltip")
                        .style("opacity", 1)
                        .html(`Mês: ${data.months[data.sales.indexOf(d)]}<br>Vendas: ${d}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").style("opacity", 0);
                });
        }

        // Create category chart
        function createCategoryChart(data) {
            const margin = {top: 20, right: 30, bottom: 40, left: 40};
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#category-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.categories)
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(data.category_sales)]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            svg.append("g")
                .call(d3.axisLeft(y));

            svg.selectAll(".bar")
                .data(data.category_sales)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", (d, i) => x(data.categories[i]))
                .attr("y", d => y(d))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d))
                .attr("fill", "#ff7f50")
                .on("mouseover", function(event, d) {
                    d3.select("#tooltip")
                        .style("opacity", 1)
                        .html(`Categoria: ${data.categories[data.category_sales.indexOf(d)]}<br>Vendas: ${d}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").style("opacity", 0);
                });
        }

        // Create pie chart
        function createPieChart(data) {
            const width = 400;
            const height = 400;
            const radius = Math.min(width, height) / 2;

            const svg = d3.select("#pie-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.categories)
                .range(["#ff7f50", "#87ceeb", "#dda0dd", "#98fb98"]);

            const pie = d3.pie()
                .value(d => d);

            const data_ready = pie(data.category_sales);

            const arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);

            svg.selectAll('slices')
                .data(data_ready)
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', (d, i) => color(data.categories[i]))
                .attr("stroke", "white")
                .style("stroke-width", "2px")
                .style("opacity", 1)
                .attr("class", "pie-slice")
                .on("mouseover", function(event, d) {
                    d3.select("#tooltip")
                        .style("opacity", 1)
                        .html(`Categoria: ${data.categories[d.index]}<br>Vendas: ${d.data}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").style("opacity", 0);
                });

            // Add labels
            svg.selectAll('labels')
                .data(data_ready)
                .enter()
                .append('text')
                .text(d => data.categories[d.index])
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .style("text-anchor", "middle")
                .style("font-size", 14);
        }

        // Create summary stats
        function createSummaryStats(data) {
            const summaryDiv = d3.select("#summary");
            summaryDiv.html(""); // Clear existing content

            const stats = [
                { label: "Total de Vendas", value: data.total_sales },
                { label: "Média Mensal", value: data.avg_sales },
                { label: "Total por Categoria", value: data.total_category_sales }
            ];

            stats.forEach(stat => {
                const item = summaryDiv.append("div").attr("class", "summary-item");
                item.append("h3").text(stat.label);
                item.append("p").text(stat.value);
            });
        }

        // Initialize dashboard
        async function init() {
            const data = await fetchData();
            createSummaryStats(data);
            createSalesChart(data);
            createCategoryChart(data);
            createPieChart(data);
        }

        // Update charts with new data
        async function updateCharts() {
            const data = await fetchData();
            // Clear existing charts
            d3.select("#sales-chart").selectAll("*").remove();
            d3.select("#category-chart").selectAll("*").remove();
            d3.select("#pie-chart").selectAll("*").remove();
            // Recreate charts
            createSalesChart(data);
            createCategoryChart(data);
            createPieChart(data);
            createSummaryStats(data);
        }

        // Load data on page load
        window.onload = function() {
            init();
            // Update every 5 seconds for real-time effect
            setInterval(updateCharts, 5000);
        };
    </script>
</body>
</html>
